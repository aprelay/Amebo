var vt=Object.defineProperty;var ze=e=>{throw TypeError(e)};var At=(e,t,r)=>t in e?vt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var E=(e,t,r)=>At(e,typeof t!="symbol"?t+"":t,r),$e=(e,t,r)=>t.has(e)||ze("Cannot "+r);var i=(e,t,r)=>($e(e,t,"read from private field"),r?r.call(e):t.get(e)),R=(e,t,r)=>t.has(e)?ze("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,r),f=(e,t,r,s)=>($e(e,t,"write to private field"),s?s.call(e,r):t.set(e,r),r),_=(e,t,r)=>($e(e,t,"access private method"),r);var Je=(e,t,r,s)=>({set _(n){f(e,t,n,r)},get _(){return i(e,t,s)}});var Qe=(e,t,r)=>(s,n)=>{let o=-1;return a(0);async function a(l){if(l<=o)throw new Error("next() called multiple times");o=l;let c,u=!1,d;if(e[l]?(d=e[l][0][0],s.req.routeIndex=l):d=l===e.length&&n||void 0,d)try{c=await d(s,()=>a(l+1))}catch(h){if(h instanceof Error&&t)s.error=h,c=await t(h,s),u=!0;else throw h}else s.finalized===!1&&r&&(c=await r(s));return c&&(s.finalized===!1||u)&&(s.res=c),s}},Nt=Symbol(),Mt=async(e,t=Object.create(null))=>{const{all:r=!1,dot:s=!1}=t,o=(e instanceof ft?e.raw.headers:e.headers).get("Content-Type");return o!=null&&o.startsWith("multipart/form-data")||o!=null&&o.startsWith("application/x-www-form-urlencoded")?Dt(e,{all:r,dot:s}):{}};async function Dt(e,t){const r=await e.formData();return r?Lt(r,t):{}}function Lt(e,t){const r=Object.create(null);return e.forEach((s,n)=>{t.all||n.endsWith("[]")?bt(r,n,s):r[n]=s}),t.dot&&Object.entries(r).forEach(([s,n])=>{s.includes(".")&&(xt(r,s,n),delete r[s])}),r}var bt=(e,t,r)=>{e[t]!==void 0?Array.isArray(e[t])?e[t].push(r):e[t]=[e[t],r]:t.endsWith("[]")?e[t]=[r]:e[t]=r},xt=(e,t,r)=>{let s=e;const n=t.split(".");n.forEach((o,a)=>{a===n.length-1?s[o]=r:((!s[o]||typeof s[o]!="object"||Array.isArray(s[o])||s[o]instanceof File)&&(s[o]=Object.create(null)),s=s[o])})},ct=e=>{const t=e.split("/");return t[0]===""&&t.shift(),t},Ct=e=>{const{groups:t,path:r}=Ut(e),s=ct(r);return Ht(s,t)},Ut=e=>{const t=[];return e=e.replace(/\{[^}]+\}/g,(r,s)=>{const n=`@${s}`;return t.push([n,r]),n}),{groups:t,path:e}},Ht=(e,t)=>{for(let r=t.length-1;r>=0;r--){const[s]=t[r];for(let n=e.length-1;n>=0;n--)if(e[n].includes(s)){e[n]=e[n].replace(s,t[r][1]);break}}return e},xe={},jt=(e,t)=>{if(e==="*")return"*";const r=e.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/);if(r){const s=`${e}#${t}`;return xe[s]||(r[2]?xe[s]=t&&t[0]!==":"&&t[0]!=="*"?[s,r[1],new RegExp(`^${r[2]}(?=/${t})`)]:[e,r[1],new RegExp(`^${r[2]}$`)]:xe[s]=[e,r[1],!0]),xe[s]}return null},Ge=(e,t)=>{try{return t(e)}catch{return e.replace(/(?:%[0-9A-Fa-f]{2})+/g,r=>{try{return t(r)}catch{return r}})}},Pt=e=>Ge(e,decodeURI),ut=e=>{const t=e.url,r=t.indexOf("/",t.indexOf(":")+4);let s=r;for(;s<t.length;s++){const n=t.charCodeAt(s);if(n===37){const o=t.indexOf("?",s),a=t.slice(r,o===-1?void 0:o);return Pt(a.includes("%25")?a.replace(/%25/g,"%2525"):a)}else if(n===63)break}return t.slice(r,s)},Ft=e=>{const t=ut(e);return t.length>1&&t.at(-1)==="/"?t.slice(0,-1):t},oe=(e,t,...r)=>(r.length&&(t=oe(t,...r)),`${(e==null?void 0:e[0])==="/"?"":"/"}${e}${t==="/"?"":`${(e==null?void 0:e.at(-1))==="/"?"":"/"}${(t==null?void 0:t[0])==="/"?t.slice(1):t}`}`),lt=e=>{if(e.charCodeAt(e.length-1)!==63||!e.includes(":"))return null;const t=e.split("/"),r=[];let s="";return t.forEach(n=>{if(n!==""&&!/\:/.test(n))s+="/"+n;else if(/\:/.test(n))if(/\?/.test(n)){r.length===0&&s===""?r.push("/"):r.push(s);const o=n.replace("?","");s+="/"+o,r.push(s)}else s+="/"+n}),r.filter((n,o,a)=>a.indexOf(n)===o)},Be=e=>/[%+]/.test(e)?(e.indexOf("+")!==-1&&(e=e.replace(/\+/g," ")),e.indexOf("%")!==-1?Ge(e,ht):e):e,dt=(e,t,r)=>{let s;if(!r&&t&&!/[%+]/.test(t)){let a=e.indexOf("?",8);if(a===-1)return;for(e.startsWith(t,a+1)||(a=e.indexOf(`&${t}`,a+1));a!==-1;){const l=e.charCodeAt(a+t.length+1);if(l===61){const c=a+t.length+2,u=e.indexOf("&",c);return Be(e.slice(c,u===-1?void 0:u))}else if(l==38||isNaN(l))return"";a=e.indexOf(`&${t}`,a+1)}if(s=/[%+]/.test(e),!s)return}const n={};s??(s=/[%+]/.test(e));let o=e.indexOf("?",8);for(;o!==-1;){const a=e.indexOf("&",o+1);let l=e.indexOf("=",o);l>a&&a!==-1&&(l=-1);let c=e.slice(o+1,l===-1?a===-1?void 0:a:l);if(s&&(c=Be(c)),o=a,c==="")continue;let u;l===-1?u="":(u=e.slice(l+1,a===-1?void 0:a),s&&(u=Be(u))),r?(n[c]&&Array.isArray(n[c])||(n[c]=[]),n[c].push(u)):n[c]??(n[c]=u)}return t?n[t]:n},Vt=dt,qt=(e,t)=>dt(e,t,!0),ht=decodeURIComponent,Ze=e=>Ge(e,ht),ue,D,q,Et,mt,ke,W,rt,ft=(rt=class{constructor(e,t="/",r=[[]]){R(this,q);E(this,"raw");R(this,ue);R(this,D);E(this,"routeIndex",0);E(this,"path");E(this,"bodyCache",{});R(this,W,e=>{const{bodyCache:t,raw:r}=this,s=t[e];if(s)return s;const n=Object.keys(t)[0];return n?t[n].then(o=>(n==="json"&&(o=JSON.stringify(o)),new Response(o)[e]())):t[e]=r[e]()});this.raw=e,this.path=t,f(this,D,r),f(this,ue,{})}param(e){return e?_(this,q,Et).call(this,e):_(this,q,mt).call(this)}query(e){return Vt(this.url,e)}queries(e){return qt(this.url,e)}header(e){if(e)return this.raw.headers.get(e)??void 0;const t={};return this.raw.headers.forEach((r,s)=>{t[s]=r}),t}async parseBody(e){var t;return(t=this.bodyCache).parsedBody??(t.parsedBody=await Mt(this,e))}json(){return i(this,W).call(this,"text").then(e=>JSON.parse(e))}text(){return i(this,W).call(this,"text")}arrayBuffer(){return i(this,W).call(this,"arrayBuffer")}blob(){return i(this,W).call(this,"blob")}formData(){return i(this,W).call(this,"formData")}addValidatedData(e,t){i(this,ue)[e]=t}valid(e){return i(this,ue)[e]}get url(){return this.raw.url}get method(){return this.raw.method}get[Nt](){return i(this,D)}get matchedRoutes(){return i(this,D)[0].map(([[,e]])=>e)}get routePath(){return i(this,D)[0].map(([[,e]])=>e)[this.routeIndex].path}},ue=new WeakMap,D=new WeakMap,q=new WeakSet,Et=function(e){const t=i(this,D)[0][this.routeIndex][1][e],r=_(this,q,ke).call(this,t);return r&&/\%/.test(r)?Ze(r):r},mt=function(){const e={},t=Object.keys(i(this,D)[0][this.routeIndex][1]);for(const r of t){const s=_(this,q,ke).call(this,i(this,D)[0][this.routeIndex][1][r]);s!==void 0&&(e[r]=/\%/.test(s)?Ze(s):s)}return e},ke=function(e){return i(this,D)[1]?i(this,D)[1][e]:e},W=new WeakMap,rt),$t={Stringify:1},pt=async(e,t,r,s,n)=>{typeof e=="object"&&!(e instanceof String)&&(e instanceof Promise||(e=e.toString()),e instanceof Promise&&(e=await e));const o=e.callbacks;return o!=null&&o.length?(n?n[0]+=e:n=[e],Promise.all(o.map(l=>l({phase:t,buffer:n,context:s}))).then(l=>Promise.all(l.filter(Boolean).map(c=>pt(c,t,!1,s,n))).then(()=>n[0]))):Promise.resolve(e)},Bt="text/plain; charset=UTF-8",We=(e,t)=>({"Content-Type":e,...t}),Oe,Ie,j,le,P,A,Se,de,he,Q,Te,ve,k,ae,st,Wt=(st=class{constructor(e,t){R(this,k);R(this,Oe);R(this,Ie);E(this,"env",{});R(this,j);E(this,"finalized",!1);E(this,"error");R(this,le);R(this,P);R(this,A);R(this,Se);R(this,de);R(this,he);R(this,Q);R(this,Te);R(this,ve);E(this,"render",(...e)=>(i(this,de)??f(this,de,t=>this.html(t)),i(this,de).call(this,...e)));E(this,"setLayout",e=>f(this,Se,e));E(this,"getLayout",()=>i(this,Se));E(this,"setRenderer",e=>{f(this,de,e)});E(this,"header",(e,t,r)=>{this.finalized&&f(this,A,new Response(i(this,A).body,i(this,A)));const s=i(this,A)?i(this,A).headers:i(this,Q)??f(this,Q,new Headers);t===void 0?s.delete(e):r!=null&&r.append?s.append(e,t):s.set(e,t)});E(this,"status",e=>{f(this,le,e)});E(this,"set",(e,t)=>{i(this,j)??f(this,j,new Map),i(this,j).set(e,t)});E(this,"get",e=>i(this,j)?i(this,j).get(e):void 0);E(this,"newResponse",(...e)=>_(this,k,ae).call(this,...e));E(this,"body",(e,t,r)=>_(this,k,ae).call(this,e,t,r));E(this,"text",(e,t,r)=>!i(this,Q)&&!i(this,le)&&!t&&!r&&!this.finalized?new Response(e):_(this,k,ae).call(this,e,t,We(Bt,r)));E(this,"json",(e,t,r)=>_(this,k,ae).call(this,JSON.stringify(e),t,We("application/json",r)));E(this,"html",(e,t,r)=>{const s=n=>_(this,k,ae).call(this,n,t,We("text/html; charset=UTF-8",r));return typeof e=="object"?pt(e,$t.Stringify,!1,{}).then(s):s(e)});E(this,"redirect",(e,t)=>{const r=String(e);return this.header("Location",/[^\x00-\xFF]/.test(r)?encodeURI(r):r),this.newResponse(null,t??302)});E(this,"notFound",()=>(i(this,he)??f(this,he,()=>new Response),i(this,he).call(this,this)));f(this,Oe,e),t&&(f(this,P,t.executionCtx),this.env=t.env,f(this,he,t.notFoundHandler),f(this,ve,t.path),f(this,Te,t.matchResult))}get req(){return i(this,Ie)??f(this,Ie,new ft(i(this,Oe),i(this,ve),i(this,Te))),i(this,Ie)}get event(){if(i(this,P)&&"respondWith"in i(this,P))return i(this,P);throw Error("This context has no FetchEvent")}get executionCtx(){if(i(this,P))return i(this,P);throw Error("This context has no ExecutionContext")}get res(){return i(this,A)||f(this,A,new Response(null,{headers:i(this,Q)??f(this,Q,new Headers)}))}set res(e){if(i(this,A)&&e){e=new Response(e.body,e);for(const[t,r]of i(this,A).headers.entries())if(t!=="content-type")if(t==="set-cookie"){const s=i(this,A).headers.getSetCookie();e.headers.delete("set-cookie");for(const n of s)e.headers.append("set-cookie",n)}else e.headers.set(t,r)}f(this,A,e),this.finalized=!0}get var(){return i(this,j)?Object.fromEntries(i(this,j)):{}}},Oe=new WeakMap,Ie=new WeakMap,j=new WeakMap,le=new WeakMap,P=new WeakMap,A=new WeakMap,Se=new WeakMap,de=new WeakMap,he=new WeakMap,Q=new WeakMap,Te=new WeakMap,ve=new WeakMap,k=new WeakSet,ae=function(e,t,r){const s=i(this,A)?new Headers(i(this,A).headers):i(this,Q)??new Headers;if(typeof t=="object"&&"headers"in t){const o=t.headers instanceof Headers?t.headers:new Headers(t.headers);for(const[a,l]of o)a.toLowerCase()==="set-cookie"?s.append(a,l):s.set(a,l)}if(r)for(const[o,a]of Object.entries(r))if(typeof a=="string")s.set(o,a);else{s.delete(o);for(const l of a)s.append(o,l)}const n=typeof t=="number"?t:(t==null?void 0:t.status)??i(this,le);return new Response(e,{status:n,headers:s})},st),y="ALL",kt="all",Gt=["get","post","put","delete","options","patch"],Rt="Can not add a route since the matcher is already built.",_t=class extends Error{},Kt="__COMPOSED_HANDLER",Xt=e=>e.text("404 Not Found",404),et=(e,t)=>{if("getResponse"in e){const r=e.getResponse();return t.newResponse(r.body,r)}return console.error(e),t.text("Internal Server Error",500)},L,O,gt,b,z,Ce,Ue,fe,Yt=(fe=class{constructor(t={}){R(this,O);E(this,"get");E(this,"post");E(this,"put");E(this,"delete");E(this,"options");E(this,"patch");E(this,"all");E(this,"on");E(this,"use");E(this,"router");E(this,"getPath");E(this,"_basePath","/");R(this,L,"/");E(this,"routes",[]);R(this,b,Xt);E(this,"errorHandler",et);E(this,"onError",t=>(this.errorHandler=t,this));E(this,"notFound",t=>(f(this,b,t),this));E(this,"fetch",(t,...r)=>_(this,O,Ue).call(this,t,r[1],r[0],t.method));E(this,"request",(t,r,s,n)=>t instanceof Request?this.fetch(r?new Request(t,r):t,s,n):(t=t.toString(),this.fetch(new Request(/^https?:\/\//.test(t)?t:`http://localhost${oe("/",t)}`,r),s,n)));E(this,"fire",()=>{addEventListener("fetch",t=>{t.respondWith(_(this,O,Ue).call(this,t.request,t,void 0,t.request.method))})});[...Gt,kt].forEach(o=>{this[o]=(a,...l)=>(typeof a=="string"?f(this,L,a):_(this,O,z).call(this,o,i(this,L),a),l.forEach(c=>{_(this,O,z).call(this,o,i(this,L),c)}),this)}),this.on=(o,a,...l)=>{for(const c of[a].flat()){f(this,L,c);for(const u of[o].flat())l.map(d=>{_(this,O,z).call(this,u.toUpperCase(),i(this,L),d)})}return this},this.use=(o,...a)=>(typeof o=="string"?f(this,L,o):(f(this,L,"*"),a.unshift(o)),a.forEach(l=>{_(this,O,z).call(this,y,i(this,L),l)}),this);const{strict:s,...n}=t;Object.assign(this,n),this.getPath=s??!0?t.getPath??ut:Ft}route(t,r){const s=this.basePath(t);return r.routes.map(n=>{var a;let o;r.errorHandler===et?o=n.handler:(o=async(l,c)=>(await Qe([],r.errorHandler)(l,()=>n.handler(l,c))).res,o[Kt]=n.handler),_(a=s,O,z).call(a,n.method,n.path,o)}),this}basePath(t){const r=_(this,O,gt).call(this);return r._basePath=oe(this._basePath,t),r}mount(t,r,s){let n,o;s&&(typeof s=="function"?o=s:(o=s.optionHandler,s.replaceRequest===!1?n=c=>c:n=s.replaceRequest));const a=o?c=>{const u=o(c);return Array.isArray(u)?u:[u]}:c=>{let u;try{u=c.executionCtx}catch{}return[c.env,u]};n||(n=(()=>{const c=oe(this._basePath,t),u=c==="/"?0:c.length;return d=>{const h=new URL(d.url);return h.pathname=h.pathname.slice(u)||"/",new Request(h,d)}})());const l=async(c,u)=>{const d=await r(n(c.req.raw),...a(c));if(d)return d;await u()};return _(this,O,z).call(this,y,oe(t,"*"),l),this}},L=new WeakMap,O=new WeakSet,gt=function(){const t=new fe({router:this.router,getPath:this.getPath});return t.errorHandler=this.errorHandler,f(t,b,i(this,b)),t.routes=this.routes,t},b=new WeakMap,z=function(t,r,s){t=t.toUpperCase(),r=oe(this._basePath,r);const n={basePath:this._basePath,path:r,method:t,handler:s};this.router.add(t,r,[s,n]),this.routes.push(n)},Ce=function(t,r){if(t instanceof Error)return this.errorHandler(t,r);throw t},Ue=function(t,r,s,n){if(n==="HEAD")return(async()=>new Response(null,await _(this,O,Ue).call(this,t,r,s,"GET")))();const o=this.getPath(t,{env:s}),a=this.router.match(n,o),l=new Wt(t,{path:o,matchResult:a,env:s,executionCtx:r,notFoundHandler:i(this,b)});if(a[0].length===1){let u;try{u=a[0][0][0][0](l,async()=>{l.res=await i(this,b).call(this,l)})}catch(d){return _(this,O,Ce).call(this,d,l)}return u instanceof Promise?u.then(d=>d||(l.finalized?l.res:i(this,b).call(this,l))).catch(d=>_(this,O,Ce).call(this,d,l)):u??i(this,b).call(this,l)}const c=Qe(a[0],this.errorHandler,i(this,b));return(async()=>{try{const u=await c(l);if(!u.finalized)throw new Error("Context is not finalized. Did you forget to return a Response object or `await next()`?");return u.res}catch(u){return _(this,O,Ce).call(this,u,l)}})()},fe),wt=[];function zt(e,t){const r=this.buildAllMatchers(),s=((n,o)=>{const a=r[n]||r[y],l=a[2][o];if(l)return l;const c=o.match(a[0]);if(!c)return[[],wt];const u=c.indexOf("",1);return[a[1][u],c]});return this.match=s,s(e,t)}var je="[^/]+",we=".*",ye="(?:|/.*)",ie=Symbol(),Jt=new Set(".\\+*[^]$()");function Qt(e,t){return e.length===1?t.length===1?e<t?-1:1:-1:t.length===1||e===we||e===ye?1:t===we||t===ye?-1:e===je?1:t===je?-1:e.length===t.length?e<t?-1:1:t.length-e.length}var Z,ee,x,se,Zt=(se=class{constructor(){R(this,Z);R(this,ee);R(this,x,Object.create(null))}insert(t,r,s,n,o){if(t.length===0){if(i(this,Z)!==void 0)throw ie;if(o)return;f(this,Z,r);return}const[a,...l]=t,c=a==="*"?l.length===0?["","",we]:["","",je]:a==="/*"?["","",ye]:a.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/);let u;if(c){const d=c[1];let h=c[2]||je;if(d&&c[2]&&(h===".*"||(h=h.replace(/^\((?!\?:)(?=[^)]+\)$)/,"(?:"),/\((?!\?:)/.test(h))))throw ie;if(u=i(this,x)[h],!u){if(Object.keys(i(this,x)).some(m=>m!==we&&m!==ye))throw ie;if(o)return;u=i(this,x)[h]=new se,d!==""&&f(u,ee,n.varIndex++)}!o&&d!==""&&s.push([d,i(u,ee)])}else if(u=i(this,x)[a],!u){if(Object.keys(i(this,x)).some(d=>d.length>1&&d!==we&&d!==ye))throw ie;if(o)return;u=i(this,x)[a]=new se}u.insert(l,r,s,n,o)}buildRegExpStr(){const r=Object.keys(i(this,x)).sort(Qt).map(s=>{const n=i(this,x)[s];return(typeof i(n,ee)=="number"?`(${s})@${i(n,ee)}`:Jt.has(s)?`\\${s}`:s)+n.buildRegExpStr()});return typeof i(this,Z)=="number"&&r.unshift(`#${i(this,Z)}`),r.length===0?"":r.length===1?r[0]:"(?:"+r.join("|")+")"}},Z=new WeakMap,ee=new WeakMap,x=new WeakMap,se),Pe,Ae,nt,er=(nt=class{constructor(){R(this,Pe,{varIndex:0});R(this,Ae,new Zt)}insert(e,t,r){const s=[],n=[];for(let a=0;;){let l=!1;if(e=e.replace(/\{[^}]+\}/g,c=>{const u=`@\\${a}`;return n[a]=[u,c],a++,l=!0,u}),!l)break}const o=e.match(/(?::[^\/]+)|(?:\/\*$)|./g)||[];for(let a=n.length-1;a>=0;a--){const[l]=n[a];for(let c=o.length-1;c>=0;c--)if(o[c].indexOf(l)!==-1){o[c]=o[c].replace(l,n[a][1]);break}}return i(this,Ae).insert(o,t,s,i(this,Pe),r),s}buildRegExp(){let e=i(this,Ae).buildRegExpStr();if(e==="")return[/^$/,[],[]];let t=0;const r=[],s=[];return e=e.replace(/#(\d+)|@(\d+)|\.\*\$/g,(n,o,a)=>o!==void 0?(r[++t]=Number(o),"$()"):(a!==void 0&&(s[Number(a)]=++t),"")),[new RegExp(`^${e}`),r,s]}},Pe=new WeakMap,Ae=new WeakMap,nt),tr=[/^$/,[],Object.create(null)],He=Object.create(null);function yt(e){return He[e]??(He[e]=new RegExp(e==="*"?"":`^${e.replace(/\/\*$|([.\\+*[^\]$()])/g,(t,r)=>r?`\\${r}`:"(?:|/.*)")}$`))}function rr(){He=Object.create(null)}function sr(e){var u;const t=new er,r=[];if(e.length===0)return tr;const s=e.map(d=>[!/\*|\/:/.test(d[0]),...d]).sort(([d,h],[m,g])=>d?1:m?-1:h.length-g.length),n=Object.create(null);for(let d=0,h=-1,m=s.length;d<m;d++){const[g,S,M]=s[d];g?n[S]=[M.map(([v])=>[v,Object.create(null)]),wt]:h++;let w;try{w=t.insert(S,h,g)}catch(v){throw v===ie?new _t(S):v}g||(r[h]=M.map(([v,$])=>{const Le=Object.create(null);for($-=1;$>=0;$--){const[be,C]=w[$];Le[be]=C}return[v,Le]}))}const[o,a,l]=t.buildRegExp();for(let d=0,h=r.length;d<h;d++)for(let m=0,g=r[d].length;m<g;m++){const S=(u=r[d][m])==null?void 0:u[1];if(!S)continue;const M=Object.keys(S);for(let w=0,v=M.length;w<v;w++)S[M[w]]=l[S[M[w]]]}const c=[];for(const d in a)c[d]=r[a[d]];return[o,c,n]}function ne(e,t){if(e){for(const r of Object.keys(e).sort((s,n)=>n.length-s.length))if(yt(r).test(t))return[...e[r]]}}var G,K,Fe,Ot,ot,nr=(ot=class{constructor(){R(this,Fe);E(this,"name","RegExpRouter");R(this,G);R(this,K);E(this,"match",zt);f(this,G,{[y]:Object.create(null)}),f(this,K,{[y]:Object.create(null)})}add(e,t,r){var l;const s=i(this,G),n=i(this,K);if(!s||!n)throw new Error(Rt);s[e]||[s,n].forEach(c=>{c[e]=Object.create(null),Object.keys(c[y]).forEach(u=>{c[e][u]=[...c[y][u]]})}),t==="/*"&&(t="*");const o=(t.match(/\/:/g)||[]).length;if(/\*$/.test(t)){const c=yt(t);e===y?Object.keys(s).forEach(u=>{var d;(d=s[u])[t]||(d[t]=ne(s[u],t)||ne(s[y],t)||[])}):(l=s[e])[t]||(l[t]=ne(s[e],t)||ne(s[y],t)||[]),Object.keys(s).forEach(u=>{(e===y||e===u)&&Object.keys(s[u]).forEach(d=>{c.test(d)&&s[u][d].push([r,o])})}),Object.keys(n).forEach(u=>{(e===y||e===u)&&Object.keys(n[u]).forEach(d=>c.test(d)&&n[u][d].push([r,o]))});return}const a=lt(t)||[t];for(let c=0,u=a.length;c<u;c++){const d=a[c];Object.keys(n).forEach(h=>{var m;(e===y||e===h)&&((m=n[h])[d]||(m[d]=[...ne(s[h],d)||ne(s[y],d)||[]]),n[h][d].push([r,o-u+c+1]))})}}buildAllMatchers(){const e=Object.create(null);return Object.keys(i(this,K)).concat(Object.keys(i(this,G))).forEach(t=>{e[t]||(e[t]=_(this,Fe,Ot).call(this,t))}),f(this,G,f(this,K,void 0)),rr(),e}},G=new WeakMap,K=new WeakMap,Fe=new WeakSet,Ot=function(e){const t=[];let r=e===y;return[i(this,G),i(this,K)].forEach(s=>{const n=s[e]?Object.keys(s[e]).map(o=>[o,s[e][o]]):[];n.length!==0?(r||(r=!0),t.push(...n)):e!==y&&t.push(...Object.keys(s[y]).map(o=>[o,s[y][o]]))}),r?sr(t):null},ot),X,F,at,or=(at=class{constructor(e){E(this,"name","SmartRouter");R(this,X,[]);R(this,F,[]);f(this,X,e.routers)}add(e,t,r){if(!i(this,F))throw new Error(Rt);i(this,F).push([e,t,r])}match(e,t){if(!i(this,F))throw new Error("Fatal error");const r=i(this,X),s=i(this,F),n=r.length;let o=0,a;for(;o<n;o++){const l=r[o];try{for(let c=0,u=s.length;c<u;c++)l.add(...s[c]);a=l.match(e,t)}catch(c){if(c instanceof _t)continue;throw c}this.match=l.match.bind(l),f(this,X,[l]),f(this,F,void 0);break}if(o===n)throw new Error("Fatal error");return this.name=`SmartRouter + ${this.activeRouter.name}`,a}get activeRouter(){if(i(this,F)||i(this,X).length!==1)throw new Error("No active router has been determined yet.");return i(this,X)[0]}},X=new WeakMap,F=new WeakMap,at),_e=Object.create(null),Y,T,te,Ee,I,V,J,me,ar=(me=class{constructor(t,r,s){R(this,V);R(this,Y);R(this,T);R(this,te);R(this,Ee,0);R(this,I,_e);if(f(this,T,s||Object.create(null)),f(this,Y,[]),t&&r){const n=Object.create(null);n[t]={handler:r,possibleKeys:[],score:0},f(this,Y,[n])}f(this,te,[])}insert(t,r,s){f(this,Ee,++Je(this,Ee)._);let n=this;const o=Ct(r),a=[];for(let l=0,c=o.length;l<c;l++){const u=o[l],d=o[l+1],h=jt(u,d),m=Array.isArray(h)?h[0]:u;if(m in i(n,T)){n=i(n,T)[m],h&&a.push(h[1]);continue}i(n,T)[m]=new me,h&&(i(n,te).push(h),a.push(h[1])),n=i(n,T)[m]}return i(n,Y).push({[t]:{handler:s,possibleKeys:a.filter((l,c,u)=>u.indexOf(l)===c),score:i(this,Ee)}}),n}search(t,r){var c;const s=[];f(this,I,_e);let o=[this];const a=ct(r),l=[];for(let u=0,d=a.length;u<d;u++){const h=a[u],m=u===d-1,g=[];for(let S=0,M=o.length;S<M;S++){const w=o[S],v=i(w,T)[h];v&&(f(v,I,i(w,I)),m?(i(v,T)["*"]&&s.push(..._(this,V,J).call(this,i(v,T)["*"],t,i(w,I))),s.push(..._(this,V,J).call(this,v,t,i(w,I)))):g.push(v));for(let $=0,Le=i(w,te).length;$<Le;$++){const be=i(w,te)[$],C=i(w,I)===_e?{}:{...i(w,I)};if(be==="*"){const B=i(w,T)["*"];B&&(s.push(..._(this,V,J).call(this,B,t,i(w,I))),f(B,I,C),g.push(B));continue}const[St,Ye,Re]=be;if(!h&&!(Re instanceof RegExp))continue;const H=i(w,T)[St],Tt=a.slice(u).join("/");if(Re instanceof RegExp){const B=Re.exec(Tt);if(B){if(C[Ye]=B[0],s.push(..._(this,V,J).call(this,H,t,i(w,I),C)),Object.keys(i(H,T)).length){f(H,I,C);const qe=((c=B[0].match(/\//))==null?void 0:c.length)??0;(l[qe]||(l[qe]=[])).push(H)}continue}}(Re===!0||Re.test(h))&&(C[Ye]=h,m?(s.push(..._(this,V,J).call(this,H,t,C,i(w,I))),i(H,T)["*"]&&s.push(..._(this,V,J).call(this,i(H,T)["*"],t,C,i(w,I)))):(f(H,I,C),g.push(H)))}}o=g.concat(l.shift()??[])}return s.length>1&&s.sort((u,d)=>u.score-d.score),[s.map(({handler:u,params:d})=>[u,d])]}},Y=new WeakMap,T=new WeakMap,te=new WeakMap,Ee=new WeakMap,I=new WeakMap,V=new WeakSet,J=function(t,r,s,n){const o=[];for(let a=0,l=i(t,Y).length;a<l;a++){const c=i(t,Y)[a],u=c[r]||c[y],d={};if(u!==void 0&&(u.params=Object.create(null),o.push(u),s!==_e||n&&n!==_e))for(let h=0,m=u.possibleKeys.length;h<m;h++){const g=u.possibleKeys[h],S=d[u.score];u.params[g]=n!=null&&n[g]&&!S?n[g]:s[g]??(n==null?void 0:n[g]),d[u.score]=!0}}return o},me),re,it,ir=(it=class{constructor(){E(this,"name","TrieRouter");R(this,re);f(this,re,new ar)}add(e,t,r){const s=lt(t);if(s){for(let n=0,o=s.length;n<o;n++)i(this,re).insert(e,s[n],r);return}i(this,re).insert(e,t,r)}match(e,t){return i(this,re).search(e,t)}},re=new WeakMap,it),pe=class extends Yt{constructor(e={}){super(e),this.router=e.router??new or({routers:[new nr,new ir]})}},cr=e=>{const r={...{origin:"*",allowMethods:["GET","HEAD","PUT","POST","DELETE","PATCH"],allowHeaders:[],exposeHeaders:[]},...e},s=(o=>typeof o=="string"?o==="*"?()=>o:a=>o===a?a:null:typeof o=="function"?o:a=>o.includes(a)?a:null)(r.origin),n=(o=>typeof o=="function"?o:Array.isArray(o)?()=>o:()=>[])(r.allowMethods);return async function(a,l){var d;function c(h,m){a.res.headers.set(h,m)}const u=await s(a.req.header("origin")||"",a);if(u&&c("Access-Control-Allow-Origin",u),r.credentials&&c("Access-Control-Allow-Credentials","true"),(d=r.exposeHeaders)!=null&&d.length&&c("Access-Control-Expose-Headers",r.exposeHeaders.join(",")),a.req.method==="OPTIONS"){r.origin!=="*"&&c("Vary","Origin"),r.maxAge!=null&&c("Access-Control-Max-Age",r.maxAge.toString());const h=await n(a.req.header("origin")||"",a);h.length&&c("Access-Control-Allow-Methods",h.join(","));let m=r.allowHeaders;if(!(m!=null&&m.length)){const g=a.req.header("Access-Control-Request-Headers");g&&(m=g.split(/\s*,\s*/))}return m!=null&&m.length&&(c("Access-Control-Allow-Headers",m.join(",")),a.res.headers.append("Vary","Access-Control-Request-Headers")),a.res.headers.delete("Content-Length"),a.res.headers.delete("Content-Type"),new Response(null,{headers:a.res.headers,status:204,statusText:"No Content"})}await l(),r.origin!=="*"&&a.header("Vary","Origin",{append:!0})}};const ce={AUTH_FAILED:{code:"AUTH_001",status:401,message:"Authentication failed"},INVALID_CREDENTIALS:{code:"AUTH_002",status:401,message:"Invalid email or password"},EMAIL_EXISTS:{code:"AUTH_003",status:409,message:"Email already registered"},USERNAME_EXISTS:{code:"AUTH_004",status:409,message:"Username already taken"},TOKEN_EXPIRED:{code:"AUTH_005",status:401,message:"Token expired"},ROOM_NOT_FOUND:{code:"ROOM_001",status:404,message:"Room not found"},NOT_MEMBER:{code:"ROOM_002",status:403,message:"You are not a member of this room"},ROOM_CREATION_FAILED:{code:"ROOM_003",status:500,message:"Failed to create room"},DM_ALREADY_EXISTS:{code:"ROOM_004",status:409,message:"Direct message already exists"},CANNOT_DM_SELF:{code:"ROOM_005",status:400,message:"Cannot create DM with yourself"},USER_NOT_FOUND:{code:"USER_001",status:404,message:"User not found"},USER_BLOCKED:{code:"USER_002",status:403,message:"User is blocked"},PRIVACY_VIOLATION:{code:"USER_003",status:403,message:"Privacy settings do not allow this action"},MESSAGE_SEND_FAILED:{code:"MSG_001",status:500,message:"Failed to send message"},MESSAGE_NOT_FOUND:{code:"MSG_002",status:404,message:"Message not found"},INVALID_CONTENT:{code:"MSG_003",status:400,message:"Invalid message content"},VALIDATION_ERROR:{code:"VAL_001",status:400,message:"Validation error"},MISSING_FIELDS:{code:"VAL_002",status:400,message:"Required fields missing"},INVALID_FORMAT:{code:"VAL_003",status:400,message:"Invalid data format"},INTERNAL_ERROR:{code:"SRV_001",status:500,message:"Internal server error"},DATABASE_ERROR:{code:"SRV_002",status:500,message:"Database error"}};function ge(e,t){const r=ce[e];return{success:!1,error:{code:r.code,message:r.message,details:t,timestamp:new Date().toISOString()}}}function ur(e){return{success:!0,data:e}}async function lr(e,t){if(console.error("[ERROR]",{message:e.message,stack:e.stack,path:t.req.path,method:t.req.method}),e.message.includes("UNIQUE constraint failed")){if(e.message.includes("email")){const s=ge("EMAIL_EXISTS");return t.json(s,ce.EMAIL_EXISTS.status)}if(e.message.includes("username")){const s=ge("USERNAME_EXISTS");return t.json(s,ce.USERNAME_EXISTS.status)}}if(e.message.includes("FOREIGN KEY constraint failed")){const s=ge("VALIDATION_ERROR","Referenced entity does not exist");return t.json(s,ce.VALIDATION_ERROR.status)}const r=ge("INTERNAL_ERROR",e.message);return t.json(r,ce.INTERNAL_ERROR.status)}function Ne(e,t){for(const r of t)if(!e[r])return`Missing required field: ${r}`;return null}function p(e,t,r){const s=ce[t],n=ge(t,r);return e.json(n,s.status)}function N(e,t,r=200){const s=ur(t);return e.json(s,r)}const Ve=new pe;Ve.post("/register",async e=>{try{const{email:t,username:r,password:s,display_name:n}=await e.req.json(),o=Ne({email:t,username:r,password:s},["email","username","password"]);if(o)return p(e,"MISSING_FIELDS",o);const l=new TextEncoder().encode(s),c=await crypto.subtle.digest("SHA-256",l),d=Array.from(new Uint8Array(c)).map(g=>g.toString(16).padStart(2,"0")).join(""),h=crypto.randomUUID();await e.env.DB.prepare(`
            INSERT INTO users (id, email, username, password_hash, display_name)
            VALUES (?, ?, ?, ?, ?)
        `).bind(h,t,r,d,n||r).run();const m=await e.env.DB.prepare(`
            SELECT id, email, username, display_name, avatar, tokens, token_tier
            FROM users WHERE id = ?
        `).bind(h).first();return console.log("[V2] ✅ User registered:",{userId:h,email:t,username:r}),N(e,{user:m},201)}catch(t){if(console.error("[V2] ❌ Registration error:",t),t.message.includes("UNIQUE constraint failed")){if(t.message.includes("email"))return p(e,"EMAIL_EXISTS");if(t.message.includes("username"))return p(e,"USERNAME_EXISTS")}return p(e,"INTERNAL_ERROR",t.message)}});Ve.post("/login",async e=>{try{const{email:t,password:r}=await e.req.json(),s=Ne({email:t,password:r},["email","password"]);if(s)return p(e,"MISSING_FIELDS",s);const o=new TextEncoder().encode(r),a=await crypto.subtle.digest("SHA-256",o),c=Array.from(new Uint8Array(a)).map(d=>d.toString(16).padStart(2,"0")).join(""),u=await e.env.DB.prepare(`
            SELECT id, email, username, display_name, avatar, tokens, token_tier, password_hash
            FROM users WHERE email = ?
        `).bind(t).first();return!u||u.password_hash!==c?p(e,"INVALID_CREDENTIALS"):(await e.env.DB.prepare(`
            UPDATE users SET online_status = 'online', last_seen = CURRENT_TIMESTAMP
            WHERE id = ?
        `).bind(u.id).run(),delete u.password_hash,console.log("[V2] ✅ User logged in:",{userId:u.id,email:t}),N(e,{user:u},200))}catch(t){return console.error("[V2] ❌ Login error:",t),p(e,"INTERNAL_ERROR",t.message)}});Ve.post("/logout",async e=>{try{const{user_id:t}=await e.req.json();return t?(await e.env.DB.prepare(`
            UPDATE users SET online_status = 'offline', last_seen = CURRENT_TIMESTAMP
            WHERE id = ?
        `).bind(t).run(),console.log("[V2] ✅ User logged out:",{userId:t}),N(e,{message:"Logged out successfully"},200)):p(e,"MISSING_FIELDS","user_id is required")}catch(t){return console.error("[V2] ❌ Logout error:",t),p(e,"INTERNAL_ERROR",t.message)}});async function dr(e,t,r){const[s,n]=t<r?[t,r]:[r,t],o=await e.prepare(`
        SELECT dm.room_id, cr.*
        FROM direct_message_rooms dm
        JOIN chat_rooms cr ON dm.room_id = cr.id
        WHERE dm.user1_id = ? AND dm.user2_id = ?
    `).bind(s,n).first();if(o){const M=t===s?n:s,w=await e.prepare(`
            SELECT id, username, display_name, avatar, online_status, last_seen
            FROM users WHERE id = ?
        `).bind(M).first();return{...o,other_user:w||void 0}}const a=crypto.randomUUID(),l=`dm-${crypto.randomUUID().slice(0,8)}`,c=await e.prepare(`
        SELECT display_name, username FROM users WHERE id = ?
    `).bind(r).first(),u=(c==null?void 0:c.display_name)||(c==null?void 0:c.username)||"Direct Message";if(!(await e.batch([e.prepare(`
            INSERT INTO chat_rooms (id, room_code, room_name, room_type, created_by)
            VALUES (?, ?, ?, 'direct', ?)
        `).bind(a,l,u,t),e.prepare(`
            INSERT INTO room_members (room_id, user_id, role)
            VALUES (?, ?, 'member')
        `).bind(a,s),e.prepare(`
            INSERT INTO room_members (room_id, user_id, role)
            VALUES (?, ?, 'member')
        `).bind(a,n),e.prepare(`
            INSERT INTO direct_message_rooms (room_id, user1_id, user2_id)
            VALUES (?, ?, ?)
        `).bind(a,s,n)])).every(M=>M.success))throw new Error("Failed to create direct message room atomically");const m=await e.prepare(`
        SELECT * FROM chat_rooms WHERE id = ?
    `).bind(a).first();if(!m)throw new Error("Room created but not found");const g=t===s?n:s,S=await e.prepare(`
        SELECT id, username, display_name, avatar, online_status, last_seen
        FROM users WHERE id = ?
    `).bind(g).first();return{...m,other_user:S||void 0}}async function hr(e,t){const s=(await e.prepare(`
        SELECT 
            cr.*,
            (SELECT COUNT(*) FROM room_members WHERE room_id = cr.id) as member_count
        FROM chat_rooms cr
        JOIN room_members rm ON cr.id = rm.room_id
        WHERE rm.user_id = ?
        ORDER BY cr.updated_at DESC
    `).bind(t).all()).results||[];return await Promise.all(s.map(async o=>{if(o.room_type==="direct"){const a=await e.prepare(`
                SELECT user1_id, user2_id
                FROM direct_message_rooms
                WHERE room_id = ?
            `).bind(o.id).first();if(a){const l=a.user1_id===t?a.user2_id:a.user1_id,c=await e.prepare(`
                    SELECT id, username, display_name, avatar, online_status, last_seen
                    FROM users WHERE id = ?
                `).bind(l).first();return{...o,other_user:c||void 0}}}return o}))}async function Ke(e,t,r){return!!await e.prepare(`
        SELECT 1 FROM room_members
        WHERE room_id = ? AND user_id = ?
    `).bind(t,r).first()}async function fr(e,t,r,s,n,o="text"){if(!await Ke(e,t,r))throw new Error("NOT_MEMBER");const l=crypto.randomUUID();if(!(await e.prepare(`
        INSERT INTO messages (id, room_id, sender_id, encrypted_content, iv, message_type)
        VALUES (?, ?, ?, ?, ?, ?)
    `).bind(l,t,r,s,n,o).run()).success)throw new Error("Failed to send message");await e.prepare(`
        UPDATE chat_rooms SET updated_at = CURRENT_TIMESTAMP WHERE id = ?
    `).bind(t).run();const u=await e.prepare(`
        SELECT * FROM messages WHERE id = ?
    `).bind(l).first();if(!u)throw new Error("Message created but not found");return u}async function Er(e,t,r,s=50){if(!await Ke(e,t,r))throw new Error("NOT_MEMBER");return((await e.prepare(`
        SELECT * FROM messages
        WHERE room_id = ?
        ORDER BY created_at DESC
        LIMIT ?
    `).bind(t,s).all()).results||[]).reverse()}async function mr(e,t,r){if(!await Ke(e,t,r))throw new Error("NOT_MEMBER");const n=await e.prepare(`
        SELECT room_type, created_by FROM chat_rooms WHERE id = ?
    `).bind(t).first();if(!n)throw new Error("ROOM_NOT_FOUND");if(n.room_type==="direct"){await e.prepare(`
            DELETE FROM room_members WHERE room_id = ? AND user_id = ?
        `).bind(t,r).run();const o=await e.prepare(`
            SELECT COUNT(*) as count FROM room_members WHERE room_id = ?
        `).bind(t).first();o&&o.count===0&&await e.prepare(`
                DELETE FROM chat_rooms WHERE id = ?
            `).bind(t).run()}else{if(n.created_by!==r)throw new Error("Only owner can delete group");await e.prepare(`
            DELETE FROM chat_rooms WHERE id = ?
        `).bind(t).run()}}const Me=new pe;Me.post("/direct",async e=>{var t;try{const{recipient_id:r,sender_id:s}=await e.req.json(),n=Ne({recipient_id:r,sender_id:s},["recipient_id","sender_id"]);if(n)return p(e,"MISSING_FIELDS",n);if(r===s)return p(e,"CANNOT_DM_SELF");const o=await e.env.DB.prepare(`
            SELECT id, message_privacy FROM users WHERE id = ?
        `).bind(r).first();if(!o)return p(e,"USER_NOT_FOUND");if(o.message_privacy==="contacts_only"){if(!await e.env.DB.prepare(`
                SELECT 1 FROM user_contacts
                WHERE user_id = ? AND contact_user_id = ? AND status = 'accepted'
            `).bind(r,s).first())return p(e,"PRIVACY_VIOLATION","This user only accepts messages from contacts")}else if(o.message_privacy==="nobody")return p(e,"PRIVACY_VIOLATION","This user does not accept messages");const a=await dr(e.env.DB,s,r);return console.log("[V2] ✅ DM created/fetched:",{roomId:a.id,user1:s,user2:r,other_user:(t=a.other_user)==null?void 0:t.username}),N(e,{room:a},200)}catch(r){return console.error("[V2] ❌ DM creation error:",r),p(e,"ROOM_CREATION_FAILED",r.message)}});Me.get("/user/:userId",async e=>{try{const t=e.req.param("userId");if(!t)return p(e,"MISSING_FIELDS","userId is required");const r=await hr(e.env.DB,t);return console.log("[V2] ✅ Loaded rooms:",{userId:t,count:r.length,sample:r.slice(0,2).map(s=>{var n;return{id:s.id,type:s.room_type,other_user:(n=s.other_user)==null?void 0:n.username}})}),N(e,{rooms:r},200)}catch(t){return console.error("[V2] ❌ Load rooms error:",t),p(e,"INTERNAL_ERROR",t.message)}});Me.post("/:roomId/leave",async e=>{try{const t=e.req.param("roomId"),{user_id:r}=await e.req.json(),s=Ne({roomId:t,user_id:r},["roomId","user_id"]);return s?p(e,"MISSING_FIELDS",s):(await mr(e.env.DB,t,r),console.log("[V2] ✅ Room deleted:",{roomId:t,userId:r}),N(e,{message:"Successfully left room"},200))}catch(t){return console.error("[V2] ❌ Delete room error:",t),t.message==="NOT_MEMBER"?p(e,"NOT_MEMBER"):t.message==="ROOM_NOT_FOUND"?p(e,"ROOM_NOT_FOUND"):p(e,"INTERNAL_ERROR",t.message)}});Me.get("/:roomId/members",async e=>{try{const t=e.req.param("roomId");if(!t)return p(e,"MISSING_FIELDS","roomId is required");const s=(await e.env.DB.prepare(`
            SELECT 
                rm.*,
                u.id as user_id,
                u.username,
                u.display_name,
                u.avatar,
                u.online_status,
                u.last_seen
            FROM room_members rm
            JOIN users u ON rm.user_id = u.id
            WHERE rm.room_id = ?
        `).bind(t).all()).results||[];return N(e,{members:s},200)}catch(t){return console.error("[V2] ❌ Get members error:",t),p(e,"INTERNAL_ERROR",t.message)}});const Xe=new pe;Xe.post("/send",async e=>{try{const{roomId:t,senderId:r,encryptedContent:s,iv:n,messageType:o}=await e.req.json(),a=Ne({roomId:t,senderId:r,encryptedContent:s,iv:n},["roomId","senderId","encryptedContent","iv"]);if(a)return p(e,"MISSING_FIELDS",a);const l=await fr(e.env.DB,t,r,s,n,o||"text");return console.log("[V2] ✅ Message sent:",{messageId:l.id,roomId:t,senderId:r,type:l.message_type}),N(e,{message:l},200)}catch(t){return console.error("[V2] ❌ Send message error:",t),t.message==="NOT_MEMBER"?p(e,"NOT_MEMBER"):p(e,"MESSAGE_SEND_FAILED",t.message)}});Xe.get("/:roomId",async e=>{try{const t=e.req.param("roomId"),r=e.req.query("userId"),s=parseInt(e.req.query("limit")||"50");if(!t||!r)return p(e,"MISSING_FIELDS","roomId and userId are required");const n=await Er(e.env.DB,t,r,s);return console.log("[V2] ✅ Messages loaded:",{roomId:t,userId:r,count:n.length}),N(e,{messages:n},200)}catch(t){return console.error("[V2] ❌ Load messages error:",t),t.message==="NOT_MEMBER"?p(e,"NOT_MEMBER"):p(e,"INTERNAL_ERROR",t.message)}});const De=new pe;De.get("/search",async e=>{try{const t=e.req.query("q")||"",r=e.req.query("userId");if(!t||t.length<2)return N(e,{users:[]},200);const n=(await e.env.DB.prepare(`
            SELECT id, username, display_name, avatar, online_status
            FROM users
            WHERE (username LIKE ? OR display_name LIKE ?)
            AND id != ?
            AND is_searchable = 1
            LIMIT 20
        `).bind(`%${t}%`,`%${t}%`,r||"").all()).results||[];return console.log("[V2] ✅ User search:",{query:t,count:n.length}),N(e,{users:n},200)}catch(t){return console.error("[V2] ❌ Search error:",t),p(e,"INTERNAL_ERROR",t.message)}});De.get("/:userId",async e=>{try{const t=e.req.param("userId");if(!t)return p(e,"MISSING_FIELDS","userId is required");const r=await e.env.DB.prepare(`
            SELECT id, username, display_name, avatar, online_status, last_seen, tokens, token_tier
            FROM users WHERE id = ?
        `).bind(t).first();return r?N(e,{user:r},200):p(e,"USER_NOT_FOUND")}catch(t){return console.error("[V2] ❌ Get user error:",t),p(e,"INTERNAL_ERROR",t.message)}});De.put("/:userId/privacy",async e=>{try{const t=e.req.param("userId"),{is_searchable:r,message_privacy:s,last_seen_privacy:n}=await e.req.json();if(!t)return p(e,"MISSING_FIELDS","userId is required");const o=[],a=[];return r!==void 0&&(o.push("is_searchable = ?"),a.push(r?1:0)),s&&(o.push("message_privacy = ?"),a.push(s)),n&&(o.push("last_seen_privacy = ?"),a.push(n)),o.length===0?p(e,"VALIDATION_ERROR","No valid fields to update"):(a.push(t),await e.env.DB.prepare(`
            UPDATE users SET ${o.join(", ")} WHERE id = ?
        `).bind(...a).run(),console.log("[V2] ✅ Privacy updated:",{userId:t,updates:o}),N(e,{message:"Privacy settings updated"},200))}catch(t){return console.error("[V2] ❌ Update privacy error:",t),p(e,"INTERNAL_ERROR",t.message)}});De.put("/:userId/online",async e=>{try{const t=e.req.param("userId"),{status:r}=await e.req.json();return!t||!r?p(e,"MISSING_FIELDS","userId and status are required"):["online","offline","away"].includes(r)?(await e.env.DB.prepare(`
            UPDATE users SET online_status = ?, last_seen = CURRENT_TIMESTAMP
            WHERE id = ?
        `).bind(r,t).run(),N(e,{status:r},200)):p(e,"VALIDATION_ERROR","Invalid status")}catch(t){return console.error("[V2] ❌ Update online status error:",t),p(e,"INTERNAL_ERROR",t.message)}});const U=new pe;U.use("/api/v2/*",cr({origin:"*",allowMethods:["GET","POST","PUT","DELETE","OPTIONS"],allowHeaders:["Content-Type","X-User-Email"]}));U.use("*",async(e,t)=>{const r=Date.now();await t();const s=Date.now()-r;console.log(`[V2] ${e.req.method} ${e.req.path} - ${e.res.status} (${s}ms)`)});U.route("/api/v2/auth",Ve);U.route("/api/v2/rooms",Me);U.route("/api/v2/messages",Xe);U.route("/api/v2/users",De);U.get("/api/v2/health",e=>e.json({status:"healthy",version:"2.0.0",timestamp:new Date().toISOString()}));U.get("/",e=>e.html(`
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Amebo v2.0 - Bug-Free Messaging</title>
            <link rel="stylesheet" href="/static_v2/css/styles.css">
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        </head>
        <body>
            <div id="app">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading...</p>
                </div>
            </div>
            
            <script type="module" src="/static_v2/js/app.js"><\/script>
        </body>
        </html>
    `));U.onError(lr);const tt=new pe,pr=Object.assign({"/src_v2/index.tsx":U});let It=!1;for(const[,e]of Object.entries(pr))e&&(tt.all("*",t=>{let r;try{r=t.executionCtx}catch{}return e.fetch(t.req.raw,t.env,r)}),tt.notFound(t=>{let r;try{r=t.executionCtx}catch{}return e.fetch(t.req.raw,t.env,r)}),It=!0);if(!It)throw new Error("Can't import modules from ['/src_v2/index.tsx']");export{tt as default};
